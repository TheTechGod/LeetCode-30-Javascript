/**
 * Interactive LeetCode 30-Day JavaScript Challenge Tracker (React, single file)
 * - Pure React (no TypeScript syntax)
 * - Tailwind classes for styling
 * - Saves to localStorage
 * - Progress bar + reset + export/import
 * - Per-day fields: done, title, link, notes
 *
 * Fixes applied for JSX build error:
 * - Replaced placeholder ellipsis in the Link input with a Unicode escape (\u2026) to avoid any JSX parsing issues.
 * - Removed text content containing ">" (e.g., "->") by switching to a Unicode arrow escape (\u2192).
 * - Kept strings ASCII-only in source by using Unicode escapes where needed.
 * - Left existing runtime tests intact and ADDED a few more console.assert tests.
 */
import { useEffect, useMemo, useState } from "react";

/** @typedef {{ done: boolean, title: string, link: string, notes: string }} Day */

const KEY = "leetcode-js-30-tracker-v1";

function blankDay() {
  return { done: false, title: "", link: "", notes: "" };
}

/** Ensure we always have exactly 30 Day objects */
function ensure30(data) {
  if (!Array.isArray(data)) return Array.from({ length: 30 }, blankDay);
  if (data.length !== 30) return Array.from({ length: 30 }, blankDay);
  return data.map((d) => ({
    done: Boolean(d && d.done),
    title: typeof (d && d.title) === "string" ? d.title : "",
    link: typeof (d && d.link) === "string" ? d.link : "",
    notes: typeof (d && d.notes) === "string" ? d.notes : "",
  }));
}

function load() {
  try {
    if (typeof window === "undefined") return Array.from({ length: 30 }, blankDay);
    const raw = window.localStorage.getItem(KEY);
    if (!raw) return Array.from({ length: 30 }, blankDay);
    const data = JSON.parse(raw);
    return ensure30(data);
  } catch {
    return Array.from({ length: 30 }, blankDay);
  }
}

function save(days) {
  try {
    if (typeof window === "undefined") return;
    window.localStorage.setItem(KEY, JSON.stringify(days));
  } catch {
    // ignore storage errors
  }
}

function calcProgress(days) {
  const done = days.reduce((acc, d) => acc + (d.done ? 1 : 0), 0);
  const pct = Math.round((done / 30) * 100);
  return { done, pct };
}

// Runtime tests (printed to console). Never change existing tests; add more below.
if (typeof window !== "undefined" && !window.__TRACKER_TESTED__) {
  window.__TRACKER_TESTED__ = true;
  (function runTests() {
    // Existing tests
    const sample = Array.from({ length: 30 }, (_, i) => ({
      done: i < 3,
      title: "",
      link: "",
      notes: "",
    }));
    const p = calcProgress(sample);
    console.assert(p.done === 3 && p.pct === 10, "calcProgress should report 3/30 = 10%.");

    const shaped = ensure30([{ done: true }]);
    console.assert(Array.isArray(shaped) && shaped.length === 30, "ensure30 should return exactly 30 items.");

    // Added tests
    const shaped2 = ensure30(Array.from({ length: 30 }, () => ({ done: 0, title: 42, link: null, notes: {} })));
    console.assert(shaped2.every(d => typeof d.title === "string" && typeof d.link === "string" && typeof d.notes === "string"), "ensure30 should coerce non-strings to empty strings.");

    const sample2 = Array.from({ length: 30 }, (_, i) => ({ done: i < 14, title: "", link: "", notes: "" }));
    const p2 = calcProgress(sample2);
    console.assert(p2.done === 14 && p2.pct === 47, "calcProgress should round 14/30 to 47%.");
  })();
}

export default function Tracker() {
  const [days, setDays] = useState(() => load());
  const [expanded, setExpanded] = useState(null);
  const [importing, setImporting] = useState(false);
  const [importText, setImportText] = useState("");

  useEffect(() => {
    save(days);
  }, [days]);

  const progress = useMemo(() => calcProgress(days), [days]);

  function toggleDay(i) {
    setDays((prev) => {
      const copy = [...prev];
      copy[i] = { ...copy[i], done: !copy[i].done };
      return copy;
    });
  }

  function updateDay(i, patch) {
    setDays((prev) => {
      const copy = [...prev];
      copy[i] = { ...copy[i], ...patch };
      return copy;
    });
  }

  function resetAll() {
    if (!window.confirm("Reset all progress? This cannot be undone.")) return;
    setDays(Array.from({ length: 30 }, blankDay));
    setExpanded(null);
  }

  function exportData() {
    const blob = new Blob([JSON.stringify(days, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "leetcode-30-tracker.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  function handleImport() {
    try {
      const data = JSON.parse(importText);
      const shaped = ensure30(data);
      setDays(shaped);
      setImporting(false);
      setImportText("");
    } catch (e) {
      window.alert("Import failed. Paste valid JSON (array of 30 items).");
    }
  }

  return (
    <div className="min-h-screen w-full bg-zinc-950 text-zinc-50">
      <div className="mx-auto max-w-6xl px-4 py-8">
        <header className="mb-6 flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">LeetCode 30-Day JavaScript Tracker</h1>
            <p className="text-zinc-400">Check a day when you finish. Your progress is saved automatically.</p>
          </div>
          <div className="flex flex-wrap gap-2">
            <button onClick={resetAll} className="rounded-2xl bg-zinc-800 px-4 py-2 text-sm hover:bg-zinc-700">Reset</button>
            <button onClick={exportData} className="rounded-2xl bg-zinc-800 px-4 py-2 text-sm hover:bg-zinc-700">Export</button>
            <button onClick={() => setImporting((v) => !v)} className="rounded-2xl bg-zinc-800 px-4 py-2 text-sm hover:bg-zinc-700">{importing ? "Close Import" : "Import"}</button>
          </div>
        </header>

        {/* Progress */}
        <div className="mb-6 rounded-2xl border border-zinc-800 bg-zinc-900/60 p-4">
          <div className="mb-2 flex items-center justify-between text-sm">
            <span className="font-medium">Progress</span>
            <span className="text-zinc-400">{progress.done}/30 days - {progress.pct}%</span>
          </div>
          <div className="h-3 w-full overflow-hidden rounded-full bg-zinc-800">
            <div
              className="h-full rounded-full bg-emerald-500 transition-all"
              style={ width: `${progress.pct}%` }
            />
          </div>
        </div>

        {/* Import panel */}
        {importing && (
          <div className="mb-6 rounded-2xl border border-zinc-800 bg-zinc-900/60 p-4">
            <p className="mb-2 text-sm text-zinc-300">Paste previously exported JSON below and click Import.</p>
            <textarea
              value={importText}
              onChange={(e) => setImportText(e.target.value)}
              className="mb-2 h-32 w-full resize-y rounded-xl border border-zinc-800 bg-zinc-950 p-3 text-sm outline-none focus:ring-2 focus:ring-emerald-500"
              placeholder={'[ { "done": true, "title": "Two Sum" }, \u2026 ]'}
            />
            <div className="flex gap-2">
              <button onClick={handleImport} className="rounded-2xl bg-emerald-600 px-4 py-2 text-sm font-medium hover:bg-emerald-500">Import</button>
              <button onClick={() => { setImporting(false); setImportText(""); }} className="rounded-2xl bg-zinc-800 px-4 py-2 text-sm hover:bg-zinc-700">Cancel</button>
            </div>
          </div>
        )}

        {/* Grid of days */}
        <ul className="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3">
          {days.map((d, i) => (
            <li key={i} className="rounded-2xl border border-zinc-800 bg-zinc-900/60 p-4">
              <div className="flex items-start justify-between gap-3">
                <div className="flex items-center gap-3">
                  <input
                    id={`day-${i}`}
                    type="checkbox"
                    className="mt-1 h-5 w-5 cursor-pointer rounded border-zinc-700 bg-zinc-950 accent-emerald-500"
                    checked={d.done}
                    onChange={() => toggleDay(i)}
                    title="Mark complete"
                  />
                  <label htmlFor={`day-${i}`} className="cursor-pointer select-none">
                    <div className="text-sm uppercase tracking-wider text-zinc-400">Day {String(i + 1).padStart(2, "0")}</div>
                    <div className="text-lg font-semibold">
                      {d.title && d.title.trim() ? d.title : "(Add title)"}
                    </div>
                  </label>
                </div>
                <button
                  className="rounded-xl bg-zinc-800 px-3 py-1 text-xs text-zinc-200 hover:bg-zinc-700"
                  onClick={() => setExpanded((e) => (e === i ? null : i))}
                >
                  {expanded === i ? "Hide" : "Edit"}
                </button>
              </div>

              {expanded === i && (
                <div className="mt-4 space-y-3">
                  <div>
                    <label className="mb-1 block text-xs text-zinc-400">Problem Title</label>
                    <input
                      value={d.title}
                      onChange={(e) => updateDay(i, { title: e.target.value })}
                      placeholder="e.g., Two Sum"
                      className="w-full rounded-xl border border-zinc-800 bg-zinc-950 p-2 text-sm outline-none focus:ring-2 focus:ring-emerald-500"
                    />
                  </div>
                  <div>
                    <label className="mb-1 block text-xs text-zinc-400">Link</label>
                    <input
                      value={d.link}
                      onChange={(e) => updateDay(i, { link: e.target.value })}
                      placeholder={'https://leetcode.com/problems/\u2026'}
                      className="w-full rounded-xl border border-zinc-800 bg-zinc-950 p-2 text-sm outline-none focus:ring-2 focus:ring-emerald-500"
                    />
                    {d.link && (
                      <a href={d.link} target="_blank" rel="noreferrer" className="mt-1 inline-block text-sm text-emerald-400 hover:underline">
                        {"Open problem \u2192"}
                      </a>
                    )}
                  </div>
                  <div>
                    <label className="mb-1 block text-xs text-zinc-400">Notes</label>
                    <textarea
                      value={d.notes}
                      onChange={(e) => updateDay(i, { notes: e.target.value })}
                      placeholder="Key idea, pitfalls, your complexity analysis, etc."
                      className="h-24 w-full rounded-xl border border-zinc-800 bg-zinc-950 p-2 text-sm outline-none focus:ring-2 focus:ring-emerald-500"
                    />
                  </div>

                  <div className="flex items-center justify-between">
                    <div className="text-xs text-zinc-400">Quick actions</div>
                    <div className="flex gap-2">
                      <button
                        className="rounded-xl bg-zinc-800 px-3 py-1 text-xs hover:bg-zinc-700"
                        onClick={() => updateDay(i, { title: "", link: "", notes: "" })}
                      >
                        Clear fields
                      </button>
                      <button
                        className="rounded-xl bg-emerald-600 px-3 py-1 text-xs font-medium hover:bg-emerald-500"
                        onClick={() => updateDay(i, { done: true })}
                      >
                        Mark done
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </li>
          ))}
        </ul>

        {/* Footer helper */}
        <div className="mt-8 rounded-2xl border border-zinc-800 bg-zinc-900/60 p-4 text-sm text-zinc-300">
          <p className="mb-1">
            Workflow tip: paste each day's problem link and a 1-2 line note. When you paste the challenge, I'll teach it using our 7-step tutorial format.
          </p>
          <p>
            Want a calendar view or streak counter? Say <span className="font-mono">add calendar</span> and I'll extend this component.
          </p>
        </div>
      </div>
    </div>
  );
}